#!/usr/bin/env bash

set -eu

script_name=$(basename $0)
if [ -f ".git/hooks/${script_name}" ]; then
  ".git/hooks/${script_name}" $@
fi

# check that we're not trying to push a WIP to master
CURRENT_BRANCH=$(git branch | grep '*' | awk '{ print $2 }')
if [ "$CURRENT_BRANCH" -eq "master" ]; then
  if [ $(git log -n 10 --oneline | grep -c -i 'wip') -ne 0  ]; then
    (>&2 echo "Looks like you are trying to push a WIP commit to master, which is naughty.")
    exit 1
  fi
fi


DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
WHITELISTS=${DIR}/whitelists

whitelisted() {
  file=$1
  path=${DIR}/whitelists.d/$file

  if [ -f "${path}" ]; then
    while read -r; do
      if [ $REPLY == $(pwd) ]; then
        return 0
      fi
    done < ${path}
  fi

  return 1
}

whitelist=""

has_whitelist() {
  hookPath=$1

  while read -ra LINE; do
    whitelistEntry="${LINE[0]}"
    if [ "$hookPath" == "$whitelistEntry" ]; then
      whitelist="${LINE[1]}"
      return 0
    fi
  done < ${WHITELISTS}

  return 1
}

HOOKS_DIR="${DIR}/$( basename ${0} ).d"

for hook in $( ls $HOOKS_DIR ); do
  REL_HOOK="$( basename ${0} ).d"/$hook

  if has_whitelist $REL_HOOK; then
    if whitelisted $whitelist; then
      continue
    fi
  fi

  $HOOKS_DIR/$hook $@
done
